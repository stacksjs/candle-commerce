// @bun
import{F as D,h as C}from"./chunk-2w0jtg7g.js";import"./chunk-m15mygrv.js";import"./chunk-1krazvx7.js";class E{constructor(){this.should_skip=!1,this.should_remove=!1,this.replacement=null,this.context={skip:()=>this.should_skip=!0,remove:()=>this.should_remove=!0,replace:(c)=>this.replacement=c}}replace(c,r,f,s){if(c&&r)if(f!=null)c[r][f]=s;else c[r]=s}remove(c,r,f){if(c&&r)if(f!==null&&f!==void 0)c[r].splice(f,1);else delete c[r]}}class w extends E{constructor(c,r){super();this.should_skip=!1,this.should_remove=!1,this.replacement=null,this.context={skip:()=>this.should_skip=!0,remove:()=>this.should_remove=!0,replace:(f)=>this.replacement=f},this.enter=c,this.leave=r}visit(c,r,f,s){if(c){if(this.enter){let i=this.should_skip,I=this.should_remove,l=this.replacement;if(this.should_skip=!1,this.should_remove=!1,this.replacement=null,this.enter.call(this.context,c,r,f,s),this.replacement)c=this.replacement,this.replace(r,f,s,c);if(this.should_remove)this.remove(r,f,s);let t=this.should_skip,m=this.should_remove;if(this.should_skip=i,this.should_remove=I,this.replacement=l,t)return c;if(m)return null}let a;for(a in c){let i=c[a];if(i&&typeof i==="object"){if(Array.isArray(i)){let I=i;for(let l=0;l<I.length;l+=1){let t=I[l];if(e(t)){if(!this.visit(t,c,a,l))l--}}}else if(e(i))this.visit(i,c,a,null)}}if(this.leave){let i=this.replacement,I=this.should_remove;if(this.replacement=null,this.should_remove=!1,this.leave.call(this.context,c,r,f,s),this.replacement)c=this.replacement,this.replace(r,f,s,c);if(this.should_remove)this.remove(r,f,s);let l=this.should_remove;if(this.replacement=i,this.should_remove=I,l)return null}}return c}}function e(c){return c!==null&&typeof c==="object"&&"type"in c&&typeof c.type==="string"}function b(c,{enter:r,leave:f}){return new w(r,f).visit(c,null)}async function G(c,r,f){let s=D(c),a=await r.getImportMap(),i=[],I=f?.autoImport!==!1,l=f?.transformVirtualImports!==!1&&r.options.virtualImports?.length;if(I||l){let t=C(s.original,{sourceType:"module",ecmaVersion:"latest",locations:!0}),m=y(a,r.options.virtualImports),u=V(t,l?m.walk:{});if(I){let S=u.unmatched;i.push(...Array.from(S).map((g)=>{let h=a.get(g);if(h&&!h.disabled)return h;return null}).filter(Boolean));for(let g of r.addons)i=await g.matchImports?.call(r,S,i)||i}m.ranges.forEach(([S,g])=>{s.remove(S,g)}),i.push(...m.imports)}return{s,strippedCode:c.toString(),matchedImports:i,isCJSContext:!1,firstOccurrence:0}}function V(c,r){let f=[],s=void 0,a=[];function i(t){s={node:t,parent:s,declarations:new Set,references:new Set},f.push(s),a.push(s)}function I(t){if(a.pop()?.node!==t)throw new Error("Scope mismatch");s=a[a.length-1]}i(void 0),b(c,{enter(t,m,u,S){switch(r?.enter?.call(this,t,m,u,S),t.type){case"ImportSpecifier":case"ImportDefaultSpecifier":case"ImportNamespaceSpecifier":s.declarations.add(t.local.name);return;case"FunctionDeclaration":case"ClassDeclaration":if(t.id)s.declarations.add(t.id.name);return;case"VariableDeclarator":if(t.id.type==="Identifier")s.declarations.add(t.id.name);else b(t.id,{enter(g){if(g.type==="ObjectPattern")g.properties.forEach((h)=>{if(h.type==="Property"&&h.value.type==="Identifier")s.declarations.add(h.value.name);else if(h.type==="RestElement"&&h.argument.type==="Identifier")s.declarations.add(h.argument.name)});else if(g.type==="ArrayPattern")g.elements.forEach((h)=>{if(h?.type==="Identifier")s.declarations.add(h.name);if(h?.type==="RestElement"&&h.argument.type==="Identifier")s.declarations.add(h.argument.name)})}});return;case"BlockStatement":i(t);return;case"Identifier":switch(m?.type){case"CallExpression":if(m.callee===t||m.arguments.includes(t))s.references.add(t.name);return;case"MemberExpression":if(m.object===t)s.references.add(t.name);return;case"VariableDeclarator":if(m.init===t)s.references.add(t.name);return;case"SpreadElement":if(m.argument===t)s.references.add(t.name);return;case"ClassDeclaration":if(m.superClass===t)s.references.add(t.name);return;case"Property":if(m.value===t)s.references.add(t.name);return;case"TemplateLiteral":if(m.expressions.includes(t))s.references.add(t.name);return;case"AssignmentExpression":if(m.right===t)s.references.add(t.name);return;case"IfStatement":case"WhileStatement":case"DoWhileStatement":if(m.test===t)s.references.add(t.name);return;case"SwitchStatement":if(m.discriminant===t)s.references.add(t.name);return}if(m?.type.includes("Expression"))s.references.add(t.name)}},leave(t,m,u,S){switch(r?.leave?.call(this,t,m,u,S),t.type){case"BlockStatement":I(t)}}});let l=new Set;for(let t of f)for(let m of t.references){let u=!1,S=t;while(S){if(S.declarations.has(m)){u=!0;break}S=S?.parent}if(!u)l.add(m)}return{unmatched:l,scopes:f}}function y(c,r=[]){let f=[],s=[];return{imports:f,ranges:s,walk:{enter(a){if(a.type==="ImportDeclaration"){if(r.includes(a.source.value))s.push([a.start,a.end]),a.specifiers.forEach((i)=>{if(i.type==="ImportSpecifier"&&i.imported.type==="Identifier"){let I=c.get(i.imported.name);if(!I)throw new Error(`[unimport] failed to find "${i.imported.name}" imported from "${a.source.value}"`);f.push({from:I.from,name:I.name,as:i.local.name})}})}}}}}export{V as traveseScopes,G as detectImportsAcorn,y as createVirtualImportsAcronWalker};
